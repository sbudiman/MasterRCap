---
title: "Mastering Software Dev in R: Earthquake Visualization"
author: "San Budiman"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MasterRCap}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, echo = FALSE, include = FALSE}
library(MasterRCap)
library(dplyr)
library(ggplot2)
library(magrittr)
library(readr)
```

MasterRCap package contains the capstone project for Coursera Mastering Software Development in R, which provides functions for data cleanup for raw data from NOAA, new Geoms for presenting earthquakes in timeline, along with labeling and theme, as well as earthquake map visualization. 

## Package Info 

The package contains 7 functions:

1. **eq_location_clean** that transforms NOAA data frame LOCATION_NAME column by trimming the country name when applicable. NOAA data frame is extracted from [National Oceanic and Atmospheric Administration website] (https://www.ngdc.noaa.gov/nndc/struts/form?t=101650&s=1&d=1)
2. **eq_clean_data** that cleans date, latitude and longitude, and location name from the source NOAA data.
3. **geom_timeline** that geom function plots earthquake in a timeline. It has the options to take additional plotting input like country, magnitude of earthquakes and  number of fatalities.
4. **geom_timeline_label** that plots timeline labels of earthquakes, and assumes that geom_timeline was used to create the timelines.
5. **theme_timeline** that is a theme function that provides better rendering for geom_timeline.
6. **eq_map** that creates a leaflet map of selected earthquakes based on input NOAA earthquake cleaned data
7. **eq_create_label** that creates a label for the eq_map leaflet map based on location, name, magnitude and fatalities from NOAA earthquake data.

## Sample Data

Sample data of all Major Earthquakes from NOAA is loaded into MajorEarthquakes data frame. To clean up this sample for use with geom and leaflet included in the package, use eq_location_clean and or eq_clean_data functions.

```{r load_MajorEarthquakes}
filename <- system.file("extdata/results", package = "MasterRCap")
MajorEarthquakes <- readr::read_delim(file=filename, delim='\t')
```

## Display earthquake timeline

Functions geom_timeline, geom_timeline_label and theme_timeline utilize `ggplot2` package to visualize earthquake timeline. The basic `geom_timeline()` geom requires clean data generated by eq_clean_data. The required aesthetics is `x` for dates, with optional aesthetics are `y` for grouping by country, and `size` and `color` that can be used according to user needs. The `geom_timeline_label()` function requires additional `label` aesthetic for labeling. For better visualization of these two geoms, `theme_timeline()` theme was added. Here is an example:

```{r eq_timeline_example, fig.width = 8, fig.height = 6}
MajorEarthquakes %>% eq_clean_data() %>%
     dplyr::filter(COUNTRY %in% c("CHINA", "JAPAN"), YEAR > 2010) %>%
     ggplot2::ggplot(aes(x = DATE,
                y = COUNTRY,
                color = as.numeric(TOTAL_DEATHS),
                size = as.numeric(EQ_PRIMARY)
     )) +
     geom_timeline() +
     geom_timeline_label(aes(label = LOCATION_NAME), n_max = 3) +
     theme_timeline() +
     ggplot2::labs(size = "Earthquake Magnitude", color = "Fatalities")
```

## Display earthquakes on map

Functions eq_map utilizes `leaflet` functions to visualize earthquakes on a map. The map is automatically trimmed to display the input data frame. Optional annotations can be created using `eq_create_label()` function. The result is an interactive map where user can click on individual points to get details of an earthquake:

```{r eq_map_example, fig.width = 8, fig.height = 6}
MajorEarthquakes %>% 
  eq_clean_data() %>% 
  dplyr::filter(COUNTRY == "INDONESIA" & YEAR >= 2010) %>% 
  dplyr::mutate(popup_text = eq_create_label(.)) %>% 
  eq_map(annot_col = "popup_text")
```
